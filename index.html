<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œå…¨ãƒŠãƒ“ãƒãƒƒãƒ—ï¼ˆæ—¥æœ¬èªãƒ»GPSå¯¾å¿œï¼‰</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <style>
        /* ãƒ™ãƒ¼ã‚¹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex; /* Flexboxã§ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’åˆ¶å¾¡ */
            overflow: hidden; /* å…¨ä½“ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ */
            color: #333;
        }

        /* å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        input, select, button {
            width: 100%;
            margin-bottom: 12px;
            padding: 10px;
            font-size: 16px;
            box-sizing: border-box;
            border-radius: 6px;
            border: 1px solid #ccc;
            transition: all 0.2s;
        }

        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            border: none;
            font-weight: 600;
        }

        button:hover {
            background-color: #0056b3;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        #sidebar {
            width: 320px;
            min-width: 320px;
            height: 100%;
            background: #ffffff;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            z-index: 1000;
            box-sizing: border-box;
            transition: transform 0.3s ease-in-out;
        }

        #sidebar h3 {
            margin-top: 0;
            color: #007bff;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        #info {
            font-size: 14px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
            margin-top: 10px;
        }

        /* ãƒãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒŠ */
        #map-container {
            flex-grow: 1; /* æ®‹ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¨ã¦å æœ‰ */
            height: 100%;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* ãƒˆãƒƒãƒ—ãƒãƒ¼ (ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±) */
        #topbar {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%); /* ä¸­å¤®å¯„ã› */
            width: 90%;
            max-width: 500px;
            height: auto;
            background: rgba(0, 123, 255, 0.95); /* ã‚ˆã‚Šæ´—ç·´ã•ã‚ŒãŸé’ */
            color: white;
            display: none;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            box-sizing: border-box;
            z-index: 1001;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            flex-wrap: nowrap;
        }

        #topbar div {
            flex-grow: 1;
        }

        #topbar span#nav-next {
            font-size: 18px;
            font-weight: bold;
            display: block;
            margin-bottom: 3px;
        }

        #topbar span#nav-remaining {
            font-size: 14px;
            font-weight: normal;
            color: #cce5ff;
        }

        #topbar button {
            background: #dc3545; /* èµ¤è‰² */
            margin-left: 15px;
            padding: 8px 15px;
            width: auto;
            min-width: 80px;
        }

        #topbar button:hover {
            background: #c82333;
        }

        /* GPSå†ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°ãƒœã‚¿ãƒ³ */
        #recenter-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            font-size: 28px;
            border-radius: 50%;
            border: 2px solid #007bff;
            background-color: white;
            color: #007bff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            transition: all 0.2s;
        }

        #recenter-btn:hover {
            background-color: #e9ecef;
        }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚«ãƒ¼ï¼ˆç§»å‹•æ™‚ã®è§’åº¦ã‚’åæ˜ ã•ã›ã‚‹ï¼‰ */
        .triangle div {
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 20px solid #dc3545; /* èµ¤ã„çŸ¢å° */
            transform-origin: bottom center;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5); /* è¦–èªæ€§å‘ä¸Š */
        }

        /* ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼ */
        #streetview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 2000;
            background: #fff; /* èƒŒæ™¯ãŒé€ã‘ãªã„ã‚ˆã†ã« */
        }

        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œã®ãŸã‚ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ */
        #sidebar-toggle {
            display: none; /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã¯éè¡¨ç¤º */
            position: absolute;
            top: 15px;
            left: 15px;
            width: 40px;
            height: 40px;
            font-size: 24px;
            line-height: 40px;
            text-align: center;
            border-radius: 50%;
            background-color: white;
            color: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 1002;
        }

        /* === ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ (å¹…768pxä»¥ä¸‹) === */
        @media (max-width: 768px) {
            html, body {
                flex-direction: column; /* ç¸¦ä¸¦ã³ */
            }

            #sidebar {
                width: 100%;
                height: auto;
                max-height: 50%;
                position: absolute;
                top: 0;
                left: 0;
                z-index: 1010;
                transform: translateX(0) translateY(-100%); /* ç”»é¢å¤–ã«éš ã™ */
                box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            }

            #sidebar.open {
                transform: translateX(0) translateY(0); /* è¡¨ç¤º */
            }

            #map-container {
                margin-left: 0;
                width: 100%;
                flex-grow: 1;
            }

            #sidebar-toggle {
                display: block; /* ãƒ¢ãƒã‚¤ãƒ«ã§è¡¨ç¤º */
            }

            #topbar {
                width: calc(100% - 30px);
                max-width: unset;
                left: 15px;
                transform: translateX(0);
            }

            /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ãŒé–‹ã„ã¦ã„ã‚‹ã¨ãã«ãƒãƒƒãƒ—æ“ä½œã‚’å¦¨ã’ã‚‹ãŸã‚ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
            .sidebar-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1005;
                display: none;
            }
            .sidebar-overlay.visible {
                display: block;
            }
        }

    </style>
</head>
<body>
    <div id="sidebar" class="closed">
        <h3>ãƒ«ãƒ¼ãƒˆæ¤œç´¢</h3>
        <input type="text" id="start" placeholder="å‡ºç™ºåœ°ï¼ˆç©ºæ¬„ã§ç¾åœ¨åœ°ï¼‰">
        <input type="text" id="end" placeholder="ç›®çš„åœ°">
        <select id="mode">
            <option value="driving">è»Š</option>
            <option value="walking">å¾’æ­©</option>
            <option value="cycling">è‡ªè»¢è»Š</option>
        </select>
        <select id="maptype">
            <option value="street">æ¨™æº–åœ°å›³</option>
            <option value="satellite">èˆªç©ºå†™çœŸ</option>
        </select>
        <button onclick="switchMapLayer()">ãƒãƒƒãƒ—åˆ‡æ›¿</button>
        <button onclick="startNormalNav()" style="background-color: #28a745;">é€šå¸¸ãƒŠãƒ“é–‹å§‹</button>
        <button onclick="startDemoNav()" style="background-color: #ffc107; color: #333;">ãƒ‡ãƒ¢èµ°è¡Œé–‹å§‹</button>
        <button onclick="showStreetView()" style="background-color: #6c757d;">ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼</button>
        <div id="info"></div>
    </div>

    <div id="map-container">
        <button id="sidebar-toggle" onclick="toggleSidebar()">â˜°</button>
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <div id="topbar">
            <div>
                <span id="nav-next">æ¬¡ã®æ›²ãŒã‚Šè§’: -</span><br>
                <span id="nav-remaining">æ®‹ã‚Š: -</span>
            </div>
            <button onclick="stopNav()">åœæ­¢</button>
        </div>

        <div id="map"></div>
        <button id="recenter-btn" onclick="recenterMap()">ğŸ“</button>
        <div id="streetview"></div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://rawcdn.githack.com/bbecquet/Leaflet.RotatedMarker/master/leaflet.rotatedMarker.js"></script>
    <script>
        // ... (JavaScriptã‚³ãƒ¼ãƒ‰ã¯å…ƒã®ã‚‚ã®ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€ä»¥ä¸‹ã®ä¿®æ­£ã‚’åŠ ãˆã¾ã™) ...

        let map = L.map('map',{zoomControl:true}).setView([35.68,139.76],13);
        let baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â©OSM'}).addTo(map);
        let satLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{subdomains:['mt0','mt1','mt2','mt3']});
        let navMarker, destMarker, routeLine;
        let routeCoords=[], maneuvers=[], navIndex=0;
        let navInterval=null;
        let startCoord=null, destCoord=null;
        let useGPS=true;
        const speech = window.speechSynthesis;
        let lastSpokenStep = null;

        // ãƒ¢ãƒã‚¤ãƒ«ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒˆã‚°ãƒ«æ©Ÿèƒ½ã®è¿½åŠ 
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            const isOpen = sidebar.classList.toggle('open');
            overlay.classList.toggle('visible', isOpen);
            if (!isOpen) {
                // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ãŸã‚‰ãƒãƒƒãƒ—ã®ã‚µã‚¤ã‚ºã‚’å†è¨ˆç®—
                setTimeout(() => map.invalidateSize(), 300); 
            }
        }

        // GPSç›£è¦–ã¨ãƒãƒ¼ã‚«ãƒ¼æ›´æ–° (æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰)
        function watchCurrentPosition(){
            if(!navigator.geolocation) return;
            navigator.geolocation.watchPosition(pos=>{
                const latlng=[pos.coords.latitude,pos.coords.longitude];
                // Headingã‚’ãƒ©ã‚¸ã‚¢ãƒ³ã‹ã‚‰åº¦ã«å¤‰æ›ã—ã€åŒ—åŸºæº–ã«èª¿æ•´ (Leaflet.RotatedMarkerã¯åº¦ã‚’æœŸå¾…)
                let heading = pos.coords.heading; 
                // headingãŒnullã¾ãŸã¯NaNã®å ´åˆã¯0ã¨ã—ã¦æ‰±ã†
                if (heading === null || isNaN(heading)) heading = 0; 

                if(!navMarker){
                    navMarker=L.marker(latlng,{
                        icon:L.divIcon({className:'triangle', html:'<div></div>'}), 
                        rotationAngle:heading
                    }).addTo(map);
                    if(!startCoord) { 
                        startCoord=latlng; 
                        map.setView(latlng,16);
                    }
                }
                
                if(useGPS){
                    navMarker.setLatLng(latlng);
                    navMarker.setRotationAngle(heading);
                    // ãƒŠãƒ“ä¸­ã«ç¾åœ¨åœ°è¿½å¾“ã‚’ç¶­æŒã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã®è¡Œã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’å¤–ã™
                    // map.setView(latlng, map.getZoom(), {animate:true}); 
                }
                startCoord=latlng; 
            },err=>console.warn(err),{enableHighAccuracy:true, maximumAge:1000, timeout:5000});
        }
        watchCurrentPosition();

        function recenterMap(){
            if(startCoord){
                map.setView(startCoord,16);
                if(navMarker) navMarker.setLatLng(startCoord);
                useGPS=true;
            } else alert("ç¾åœ¨åœ°ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“");
        }
        
        // --- ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã€ç›®çš„åœ°æ¤œç´¢ã€ãƒãƒƒãƒ—åˆ‡æ›¿ã€ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼ (JavaScriptã®ä¿®æ­£) ---

        // (geocode, searchDestination, switchMapLayer, primeSpeech, 
        // startNormalNav, startDemoNav, startNav ã®å„é–¢æ•°ã¯åŸºæœ¬çš„ã«å…ƒã®ã¾ã¾ã§OK)

        // **StreetViewé–¢æ•°ã®ä¿®æ­£**
        function showStreetView(){
            if(!destCoord) return alert("ç›®çš„åœ°ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„");
            
            // Google MapsåŸ‹ã‚è¾¼ã¿ãƒ“ãƒ¥ãƒ¼ã«ä¿®æ­£ (ç·¯åº¦/çµŒåº¦ã§ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼ä½ç½®ã‚’æŒ‡å®š)
            // å®Ÿéš›ã®ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼ã¯APIã‚­ãƒ¼ãŒå¿…è¦ãªãŸã‚ã€ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ãƒãƒƒãƒ—åŸ‹ã‚è¾¼ã¿è¡¨ç¤ºã«å¤‰æ›´
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«APIã‚­ãƒ¼ã®å¿…è¦æ€§ã‚’ä¼ãˆã‚‹
            const embedSrc = `https://maps.google.com/maps?q=${destCoord[0]},${destCoord[1]}&hl=ja&z=16&output=embed`;
            
            const iframe=document.createElement('iframe');
            iframe.width="100%";
            iframe.height="100%";
            iframe.style.border=0;
            iframe.src=embedSrc;
            
            const sv=document.getElementById('streetview');
            sv.style.display='block';
            sv.innerHTML='';
            sv.appendChild(iframe);
            
            alert("Google Mapsã®åŸ‹ã‚è¾¼ã¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚å®Œå…¨ãªã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã«ã¯ã€Google Maps Platform APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚");
        }

        // **stopNavé–¢æ•°ã®ä¿®æ­£ (ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´)**
        function stopNav(){
            if(navInterval) clearInterval(navInterval);
            navInterval=null;
            document.getElementById('sidebar').style.display='block';
            document.getElementById('topbar').style.display='none';
            document.getElementById('sidebar').classList.remove('open'); // ãƒ¢ãƒã‚¤ãƒ«ã®å ´åˆã®ã‚¯ãƒ©ã‚¹ã‚‚å‰Šé™¤
            document.querySelector('.sidebar-overlay').classList.remove('visible'); // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚‚éè¡¨ç¤ºã«
            
            // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¤‰æ›´å¾Œã®ãƒãƒƒãƒ—ã‚µã‚¤ã‚ºå†è¨ˆç®—
            setTimeout(()=>map.invalidateSize(),100); 
            
            if(routeLine) map.removeLayer(routeLine);
            routeLine=null;
            routeCoords=[];
            maneuvers=[];
            navIndex=0;
            document.getElementById('streetview').style.display='none';
            document.getElementById('streetview').innerHTML='';
            useGPS=true;
            lastSpokenStep=null;
        }

        // --- (getDistance, calculateRemainingDistance, getInstructionText, getDirectionText, speak ã®å„é–¢æ•°ã¯å…ƒã®ã¾ã¾ã§OK) ---

        async function geocode(query){
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
            const data = await res.json();
            if(data.length===0) throw "ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
            return {lat:parseFloat(data[0].lat), lng:parseFloat(data[0].lon), name:data[0].display_name};
        }
        
        async function searchDestination(){
            try{
                const endAddr=document.getElementById('end').value;
                if(!endAddr){ alert("ç›®çš„åœ°ã‚’å…¥åŠ›"); return false; }
                const dest=await geocode(endAddr);
                destCoord=[dest.lat,dest.lng];
                if(destMarker) map.removeLayer(destMarker);
                destMarker=L.marker(destCoord).addTo(map).bindPopup(dest.name).openPopup();
                map.setView(destCoord,16);
                document.getElementById('info').innerText=`æ¤œç´¢å®Œäº†: ${dest.name}`;
                speak(`ç›®çš„åœ°ã¯${dest.name}ã§ã™`);
                if(routeLine) map.removeLayer(routeLine);
                return true;
            }catch(err){
                alert("ç›®çš„åœ°æ¤œç´¢å¤±æ•—: "+err);
                return false;
            }
        }
        
        function switchMapLayer(){
            const type=document.getElementById('maptype').value;
            if(type==='satellite'){
                map.addLayer(satLayer);
                map.removeLayer(baseLayer);
            } else{
                map.addLayer(baseLayer);
                map.removeLayer(satLayer);
            }
        }

        function primeSpeech(){
            if(speech.speaking) speech.cancel();
            let u=new SpeechSynthesisUtterance(' ');
            u.volume=0;
            u.lang='ja-JP';
            speech.speak(u);
        }

        async function startNormalNav(){
            primeSpeech();
            useGPS=true;
            const ok = await searchDestination();
            if(!ok) return;
            const startAddr=document.getElementById('start').value;
            let start;
            if(startAddr){
                try{
                    const s=await geocode(startAddr);
                    start=[s.lat,s.lng];
                } catch(err){
                    alert("å‡ºç™ºåœ°æ¤œç´¢å¤±æ•—");
                    return;
                }
            } else{
                if(!startCoord){
                    alert("ç¾åœ¨åœ°å–å¾—å¾…æ©Ÿ");
                    return;
                }
                start=startCoord;
            }
            await startNav(start,destCoord,true);
            
            // ãƒŠãƒ“é–‹å§‹æ™‚ã«ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹ (ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ)
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('open')) {
                toggleSidebar();
            }
        }

        async function startDemoNav(){
            primeSpeech();
            useGPS=false;
            const ok=await searchDestination();
            if(!ok) return;
            const startAddr=document.getElementById('start').value;
            let start;
            if(startAddr){
                try{
                    const s=await geocode(startAddr);
                    start=[s.lat,s.lng];
                } catch(err){
                    alert("å‡ºç™ºåœ°æ¤œç´¢å¤±æ•—");
                    return;
                }
            } else start=startCoord || [map.getCenter().lat,map.getCenter().lng];
            await startNav(start,destCoord,false);

            // ãƒŠãƒ“é–‹å§‹æ™‚ã«ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹ (ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ)
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('open')) {
                toggleSidebar();
            }
        }

        async function startNav(start,end,isReal){
            if(navInterval) clearInterval(navInterval);
            navInterval=null;
            
            // ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã®ãŸã‚ display:none ã‚’ã‚„ã‚ã€CSSã§åˆ¶å¾¡
            if (window.innerWidth > 768) {
                document.getElementById('sidebar').style.display='none';
            } else {
                // ãƒ¢ãƒã‚¤ãƒ«ã§ãƒŠãƒ“é–‹å§‹æ™‚ã¯éš ã™
                document.getElementById('sidebar').style.transform = 'translateY(-100%)'; 
            }
            document.getElementById('topbar').style.display='flex';
            setTimeout(()=>map.invalidateSize(),100);

            const mode=document.getElementById('mode').value;
            const url=`https://router.project-osrm.org/route/v1/${mode}/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson&steps=true&radiuses=unlimited;unlimited`;
            let data;
            try{
                const res=await fetch(url);
                data=await res.json();
                if(!data.routes || data.routes.length===0 || data.code!=='Ok'){
                    alert("ãƒ«ãƒ¼ãƒˆå–å¾—å¤±æ•—");
                    stopNav();
                    return;
                }
            }catch(err){
                alert("ãƒ«ãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼");
                stopNav();
                return;
            }

            routeCoords=[]; maneuvers=[]; lastSpokenStep=null; navIndex=0;
            data.routes[0].legs[0].steps.forEach(step=>{
                const loc=[step.maneuver.location[1], step.maneuver.location[0]];
                maneuvers.push({loc, type:step.maneuver.type, modifier:step.maneuver.modifier, name:step.name, destinations:step.destinations, exits:step.exits, classes:(step.intersections && step.intersections[0] && step.intersections[0].classes) || [], done:false});
                step.geometry.coordinates.forEach(c=>routeCoords.push([c[1],c[0]]));
            });

            const actualStart=[data.routes[0].legs[0].steps[0].maneuver.location[1], data.routes[0].legs[0].steps[0].maneuver.location[0]];
            if(routeLine) map.removeLayer(routeLine);
            routeLine=L.polyline(routeCoords,{color:'blue',weight:6}).addTo(map);

            if(navMarker) navMarker.setLatLng(actualStart);
            else navMarker=L.marker(actualStart,{icon:L.divIcon({className:'triangle', html:'<div></div>'}),rotationAngle:0}).addTo(map);

            navInterval=setInterval(()=>{
                let pos=isReal? startCoord:routeCoords[navIndex];
                if(!pos) return;

                if(!isReal){
                    const nextPos=routeCoords[Math.min(navIndex+1,routeCoords.length-1)];
                    navMarker.setLatLng(pos);
                    // ç·¯åº¦çµŒåº¦ã®å·®ã‹ã‚‰è§’åº¦ã‚’è¨ˆç®—
                    const angleRad=Math.atan2(nextPos[0]-pos[0], nextPos[1]-pos[1]);
                    const angleDeg=angleRad*180/Math.PI; 
                    navMarker.setRotationAngle(angleDeg); 
                    map.setView(pos,17,{animate:true, duration:0.5});
                    navIndex++;
                }

                const nextManeuver=maneuvers.find(m=>!m.done);
                if(nextManeuver){
                    const dist=getDistance(pos,nextManeuver.loc);
                    const distStr=dist>=1000? (dist/1000).toFixed(1)+' km' : Math.round(dist/10)*10+' m';
                    const instr=getInstructionText(nextManeuver);
                    document.getElementById('nav-next').innerText=`æ¬¡: ${distStr} - ${instr}`;

                    // 40mä»¥ä¸‹ã§éŸ³å£°æ¡ˆå†…
                    if(dist<40 && lastSpokenStep!==nextManeuver){
                        speak(instr);
                        lastSpokenStep=nextManeuver;
                        nextManeuver.done=true;
                    }
                }else document.getElementById('nav-next').innerText='ã¾ã‚‚ãªãåˆ°ç€';

                const remaining=calculateRemainingDistance(navIndex,routeCoords);
                document.getElementById('nav-remaining').innerText=`æ®‹ã‚Š: ${remaining}`;

                if(!isReal && navIndex>=routeCoords.length){
                    stopNav();
                    speak("ç›®çš„åœ°ã«åˆ°ç€ã—ã¾ã—ãŸ");
                    alert("ç›®çš„åœ°ã«åˆ°ç€ã—ã¾ã—ãŸ");
                }
            },500);
        }

        function getDistance(a,b){
            const R=6371000;
            const dLat=(b[0]-a[0])*Math.PI/180;
            const dLon=(b[1]-a[1])*Math.PI/180;
            const lat1=a[0]*Math.PI/180, lat2=b[0]*Math.PI/180;
            const d=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
            return 2*R*Math.atan2(Math.sqrt(d),Math.sqrt(1-d));
        }

        function calculateRemainingDistance(idx,coords){
            if(idx===null || !coords || coords.length === 0) return '-';
            let sum=0;
            for(let i=idx;i<coords.length-1;i++) sum+=getDistance(coords[i],coords[i+1]);
            return sum>=1000? (sum/1000).toFixed(1)+' km' : Math.round(sum/10)*10+' m';
        }

        function getInstructionText(m){
            const type=m.type;
            const mod=m.modifier;
            const name=m.name||'';
            const destinations=(m.destinations||'').split(',')[0];
            const exits=m.exits;
            const classes=m.classes||[];
            if(classes.includes('toll_booth')) return (name||'æ–™é‡‘æ‰€')+' ã‚’é€šéã—ã¾ã™';
            if(type==='service' || classes.includes('service_area') || classes.includes('rest_area')) return (name||'ã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒªã‚¢')+' ã«å…¥ã‚Šã¾ã™';
            if(type==='off ramp' && (name.toUpperCase().includes('PA') || name.toUpperCase().includes('SA'))) return name+' ã«å…¥ã‚Šã¾ã™';
            
            switch(type){
                case 'depart': return (name||'é“è·¯')+' ã«å…¥ã‚Šã¾ã™';
                case 'on ramp': return (name||'ãƒ©ãƒ³ãƒ—')+' ã‹ã‚‰é«˜é€Ÿé“è·¯ã«å…¥ã‚Šã¾ã™';
                case 'off ramp': return (destinations? destinations+' æ–¹é¢ã€':'')+(name||'å‡ºå£')+(exits? ' (å‡ºå£ '+exits+')':'')+' ã§é«˜é€Ÿé“è·¯ã‚’é™ã‚Šã¾ã™';
                case 'fork': return (name?name+' ã§ ':'')+(destinations? destinations+' æ–¹é¢ã€':'')+getDirectionText(mod)+' æ–¹å‘ã§ã™';
                case 'merge': return (destinations? destinations+' æ–¹é¢ã€':'')+(name? name+' ã‹ã‚‰ ':'')+'åˆæµã—ã¾ã™';
                case 'turn': 
                    if(mod==='uturn') return 'Uã‚¿ãƒ¼ãƒ³ã—ã¾ã™';
                    if(name) return name+' ã‚’ '+getDirectionText(mod)+' æ–¹å‘ã§ã™';
                    return getDirectionText(mod)+' ã«æ›²ãŒã‚Šã¾ã™';
                case 'continue': 
                case 'new name': 
                    if(mod==='uturn') return 'Uã‚¿ãƒ¼ãƒ³ã—ã¾ã™';
                    if(name) return name+' ã«å…¥ã‚Šã¾ã™';
                    return 'é“ãªã‚Šã«é€²ã‚€';
                case 'roundabout': return 'ãƒ­ãƒ¼ã‚¿ãƒªãƒ¼ã«å…¥ã‚Šã¾ã™';
                case 'arrive': return 'ç›®çš„åœ°ã«åˆ°ç€ã—ã¾ã™';
                default: return mod? getDirectionText(mod)+' ã«æ›²ãŒã‚Šã¾ã™':'é“ãªã‚Šã«é€²ã‚€';
            }
        }

        function getDirectionText(mod){
            switch(mod){
                case 'left': return 'å·¦';
                case 'right': return 'å³';
                case 'slight left': return 'ã‚„ã‚„å·¦';
                case 'slight right': return 'ã‚„ã‚„å³';
                case 'sharp left': return 'ãã¤ãå·¦';
                case 'sharp right': return 'ãã¤ãå³';
                case 'straight': return 'ç›´é€²';
                default: return 'é€²ã‚€';
            }
        }

        function speak(text){
            if(!speech) return;
            // æ—¢ã«ç™ºè©±ä¸­ã®å ´åˆã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦æ–°ã—ã„ç™ºè©±ã‚’å„ªå…ˆ
            if(speech.speaking) speech.cancel(); 
            const u=new SpeechSynthesisUtterance(text);
            u.lang='ja-JP';
            speech.speak(u);
        }

        // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã®ãƒãƒƒãƒ—ã‚µã‚¤ã‚ºèª¿æ•´
        window.addEventListener('load', () => {
            map.invalidateSize();
        });

        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã®ãƒãƒƒãƒ—ã‚µã‚¤ã‚ºèª¿æ•´
        window.addEventListener('resize', () => {
             // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®çŠ¶æ…‹ã«åˆã‚ã›ã¦èª¿æ•´
            if (window.innerWidth > 768 || !document.getElementById('sidebar').classList.contains('open')) {
                map.invalidateSize();
            }
        });

    </script>
</body>
</html>
