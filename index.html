<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œå…¨ãƒŠãƒ“ãƒãƒƒãƒ—ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¿®æ­£ç‰ˆï¼‰</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <style>
        /* --- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®åŸºæœ¬è¨­å®š (Flexbox) --- */
        html, body {
            height: 100%;
            margin: 0;
            font-family: sans-serif;
            display: flex; /* æ¨ªä¸¦ã³ã«ã™ã‚‹ãŸã‚ã®é‡è¦ãªè¨­å®š */
            flex-direction: row; /* å·¦ã‹ã‚‰å³ã¸ä¸¦ã¹ã‚‹ */
            overflow: hidden; /* ç”»é¢ã‹ã‚‰ã¯ã¿å‡ºã—é˜²æ­¢ */
        }

        /* --- ã‚µã‚¤ãƒ‰ãƒãƒ¼ --- */
        #sidebar {
            width: 300px;
            min-width: 300px; /* ç¸®ã¾ãªã„ã‚ˆã†ã«å›ºå®š */
            height: 100%;
            background: #f9f9f9;
            padding: 10px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.3);
            overflow-y: auto;
            z-index: 1000;
            box-sizing: border-box;
            /* floatã¯å‰Šé™¤ */
        }

        /* --- åœ°å›³ã‚¨ãƒªã‚¢ --- */
        #map-container {
            flex-grow: 1; /* æ®‹ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¨ã¦åŸ‹ã‚ã‚‹ */
            height: 100%;
            position: relative;
            z-index: 1;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* --- UIãƒ‘ãƒ¼ãƒ„ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        input, select, button {
            width: 100%;
            margin-bottom: 10px;
            padding: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã®ä¸Šéƒ¨ãƒãƒ¼ */
        #topbar {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            height: auto;
            background: green;
            color: white;
            display: none; /* æœ€åˆã¯éè¡¨ç¤º */
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            box-sizing: border-box;
            z-index: 1001;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            flex-wrap: wrap;
        }

        #topbar span#nav-next { font-size: 20px; font-weight: bold; }
        #topbar span#nav-remaining { font-size: 16px; font-weight: normal; color: #f0f0f0; }
        #topbar button { 
            position: static; 
            background: #f44336; 
            color: white; 
            border: none; 
            padding: 5px 10px; 
            font-size: 14px; 
            font-weight: bold; 
            cursor: pointer; 
            border-radius: 5px; 
            width: auto; 
            margin-bottom: 0; 
        }

        /* ç¾åœ¨åœ°ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
        #recenter-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            font-size: 24px;
            border-radius: 50%;
            border: none;
            background-color: white;
            color: #333;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        #recenter-btn:hover { background-color: #f4f4f4; }

        #info { font-size: 14px; }

        /* ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ï¼ˆçŸ¢å°ï¼‰ */
        .triangle div {
            width: 0; height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-bottom: 24px solid red;
            transform-origin: bottom center;
            clip-path: polygon(50% 0%, 100% 100%, 70% 100%, 50% 70%, 30% 100%, 0% 100%);
        }

        /* ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        #streetview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 2000;
            background: white;
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <h3>ãƒ«ãƒ¼ãƒˆæ¤œç´¢</h3>
        <input type="text" id="start" placeholder="å‡ºç™ºåœ°ï¼ˆç©ºæ¬„ã§ç¾åœ¨åœ°ï¼‰">
        <input type="text" id="end" placeholder="ç›®çš„åœ°">
        <select id="mode">
            <option value="driving">è»Š</option>
            <option value="walking">å¾’æ­©</option>
            <option value="cycling">è‡ªè»¢è»Š</option>
        </select>
        <select id="maptype">
            <option value="street">æ¨™æº–åœ°å›³</option>
            <option value="satellite">èˆªç©ºå†™çœŸ</option>
        </select>
        <button onclick="switchMapLayer()">ãƒãƒƒãƒ—åˆ‡æ›¿</button>
        <button onclick="startNormalNav()">é€šå¸¸ãƒŠãƒ“é–‹å§‹</button>
        <button onclick="startDemoNav()">ãƒ‡ãƒ¢èµ°è¡Œé–‹å§‹</button>
        <button onclick="showStreetView()">ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼</button>
        <div id="info"></div>
    </div>

    <div id="map-container">
        <div id="topbar">
            <div>
                <span id="nav-next">æ¬¡ã®æ›²ãŒã‚Šè§’: -</span><br>
                <span id="nav-remaining">æ®‹ã‚Š: -</span>
            </div>
            <button onclick="stopNav()">åœæ­¢</button>
        </div>

        <div id="map"></div>
        <button id="recenter-btn" onclick="recenterMap()">ğŸ“</button>
        <div id="streetview"></div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://rawcdn.githack.com/bbecquet/Leaflet.RotatedMarker/master/leaflet.rotatedMarker.js"></script>
    <script>
        let map = L.map('map', { zoomControl: true }).setView([35.68, 139.76], 13);
        let baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â©OSM' }).addTo(map);
        let satLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { subdomains: ['mt0', 'mt1', 'mt2', 'mt3'] });
        
        let navMarker, destMarker, routeLine;
        let routeCoords = [], maneuvers = [], navIndex = 0;
        let navInterval = null;
        let startCoord = null, destCoord = null;
        let useGPS = true;
        const speech = window.speechSynthesis;
        let lastSpokenStep = null;

        // --- ç¾åœ¨åœ°ç›£è¦– ---
        function watchCurrentPosition() {
            if (!navigator.geolocation) return;
            navigator.geolocation.watchPosition(pos => {
                const latlng = [pos.coords.latitude, pos.coords.longitude];
                const heading = pos.coords.heading || 0;
                
                if (!navMarker) {
                    navMarker = L.marker(latlng, { icon: L.divIcon({ className: 'triangle', html: '<div></div>' }), rotationAngle: 0 }).addTo(map);
                    if (!startCoord) {
                        startCoord = latlng;
                        map.setView(latlng, 16);
                    }
                }
                
                if (useGPS) {
                    navMarker.setLatLng(latlng);
                    navMarker.setRotationAngle(heading);
                }
                startCoord = latlng;
            }, err => console.warn(err), { enableHighAccuracy: true, maximumAge: 1000, timeout: 5000 });
        }
        watchCurrentPosition();

        function recenterMap() {
            if (startCoord) {
                map.setView(startCoord, 16);
                if (navMarker) navMarker.setLatLng(startCoord);
                useGPS = true;
            } else alert("ç¾åœ¨åœ°ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“");
        }

        async function geocode(query) {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
            const data = await res.json();
            if (data.length === 0) throw "ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
            return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon), name: data[0].display_name };
        }

        async function searchDestination() {
            try {
                const endAddr = document.getElementById('end').value;
                if (!endAddr) {
                    alert("ç›®çš„åœ°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                    return false;
                }
                const dest = await geocode(endAddr);
                destCoord = [dest.lat, dest.lng];
                
                if (destMarker) map.removeLayer(destMarker);
                destMarker = L.marker(destCoord).addTo(map).bindPopup(dest.name).openPopup();
                map.setView(destCoord, 16);
                
                document.getElementById('info').innerText = `æ¤œç´¢å®Œäº†: ${dest.name}`;
                speak(`ç›®çš„åœ°ã¯${dest.name}ã§ã™`);
                if (routeLine) map.removeLayer(routeLine);
                return true;
            } catch (err) {
                alert("ç›®çš„åœ°æ¤œç´¢å¤±æ•—: " + err);
                return false;
            }
        }

        function switchMapLayer() {
            const type = document.getElementById('maptype').value;
            if (type === 'satellite') {
                map.addLayer(satLayer);
                map.removeLayer(baseLayer);
            } else {
                map.addLayer(baseLayer);
                map.removeLayer(satLayer);
            }
        }

        function showStreetView() {
            if (!destCoord) return alert("ç›®çš„åœ°ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„");
            // â€»æ³¨æ„: ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼ã®åŸ‹ã‚è¾¼ã¿ã«ã¯æœ‰åŠ¹ãªGoogle Maps API KeyãŒå¿…è¦ã§ã™
            const apiKey = "YOUR_API_KEY"; 
            const iframe = document.createElement('iframe');
            iframe.width = "100%";
            iframe.height = "100%";
            iframe.style.border = 0;
            // æ­£ã—ã„åŸ‹ã‚è¾¼ã¿URLå½¢å¼ã«å¤‰æ›´
            iframe.src = `https://www.google.com/maps/embed/v1/streetview?key=${apiKey}&location=${destCoord[0]},${destCoord[1]}`;
            
            const sv = document.getElementById('streetview');
            sv.style.display = 'block';
            sv.innerHTML = '';
            sv.appendChild(iframe);
        }

        function primeSpeech() {
            if (speech.speaking) speech.cancel();
            let u = new SpeechSynthesisUtterance(' ');
            u.volume = 0;
            u.lang = 'ja-JP';
            speech.speak(u);
        }

        async function startNormalNav() {
            primeSpeech();
            useGPS = true;
            const ok = await searchDestination();
            if (!ok) return;
            
            const startAddr = document.getElementById('start').value;
            let start;
            if (startAddr) {
                try {
                    const s = await geocode(startAddr);
                    start = [s.lat, s.lng];
                } catch (err) { alert("å‡ºç™ºåœ°æ¤œç´¢å¤±æ•—"); return; }
            } else {
                if (!startCoord) { alert("ç¾åœ¨åœ°å–å¾—å¾…æ©Ÿ"); return; }
                start = startCoord;
            }
            await startNav(start, destCoord, true);
        }

        async function startDemoNav() {
            primeSpeech();
            useGPS = false;
            const ok = await searchDestination();
            if (!ok) return;
            
            const startAddr = document.getElementById('start').value;
            let start;
            if (startAddr) {
                try {
                    const s = await geocode(startAddr);
                    start = [s.lat, s.lng];
                } catch (err) { alert("å‡ºç™ºåœ°æ¤œç´¢å¤±æ•—"); return; }
            } else {
                start = startCoord || [map.getCenter().lat, map.getCenter().lng];
            }
            await startNav(start, destCoord, false);
        }

        async function startNav(start, end, isReal) {
            if (navInterval) clearInterval(navInterval);
            navInterval = null;

            // --- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¤‰æ›´: ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’éš ã™ ---
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('topbar').style.display = 'flex';
            
            // åœ°å›³ã‚µã‚¤ã‚ºæ›´æ–°ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¤‰æ›´ã‚’åæ˜ ï¼‰
            setTimeout(() => map.invalidateSize(), 100);

            const mode = document.getElementById('mode').value;
            const url = `https://router.project-osrm.org/route/v1/${mode}/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson&steps=true&radiuses=unlimited;unlimited`;

            let data;
            try {
                const res = await fetch(url);
                data = await res.json();
                if (!data.routes || data.routes.length === 0 || data.code !== 'Ok') {
                    alert("ãƒ«ãƒ¼ãƒˆå–å¾—å¤±æ•—");
                    stopNav();
                    return;
                }
            } catch (err) {
                alert("ãƒ«ãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼");
                stopNav();
                return;
            }

            routeCoords = [];
            maneuvers = [];
            lastSpokenStep = null;
            navIndex = 0;

            data.routes[0].legs[0].steps.forEach(step => {
                const loc = [step.maneuver.location[1], step.maneuver.location[0]];
                maneuvers.push({
                    loc,
                    type: step.maneuver.type,
                    modifier: step.maneuver.modifier,
                    name: step.name,
                    destinations: step.destinations,
                    exits: step.exits,
                    classes: (step.intersections && step.intersections[0] && step.intersections[0].classes) || [],
                    done: false
                });
                step.geometry.coordinates.forEach(c => routeCoords.push([c[1], c[0]]));
            });

            const actualStart = [data.routes[0].legs[0].steps[0].maneuver.location[1], data.routes[0].legs[0].steps[0].maneuver.location[0]];

            if (routeLine) map.removeLayer(routeLine);
            routeLine = L.polyline(routeCoords, { color: 'blue', weight: 6 }).addTo(map);

            if (navMarker) navMarker.setLatLng(actualStart);
            else navMarker = L.marker(actualStart, { icon: L.divIcon({ className: 'triangle', html: '<div></div>' }), rotationAngle: 0 }).addTo(map);

            navInterval = setInterval(() => {
                let pos = isReal ? startCoord : routeCoords[navIndex];
                if (!pos) return;

                if (!isReal) {
                    const nextPos = routeCoords[Math.min(navIndex + 1, routeCoords.length - 1)];
                    navMarker.setLatLng(pos);
                    const angle = Math.atan2(nextPos[1] - pos[1], nextPos[0] - pos[0]) * 180 / Math.PI;
                    navMarker.setRotationAngle(angle);
                    map.setView(pos, 17, { animate: true });
                    navIndex++;
                }

                const nextManeuver = maneuvers.find(m => !m.done);
                if (nextManeuver) {
                    const dist = getDistance(pos, nextManeuver.loc);
                    const distStr = dist >= 1000 ? (dist / 1000).toFixed(1) + ' km' : Math.round(dist / 10) * 10 + ' m';
                    const instr = getInstructionText(nextManeuver);
                    document.getElementById('nav-next').innerText = `æ¬¡: ${distStr} - ${instr}`;

                    if (dist < 40 && lastSpokenStep !== nextManeuver) {
                        speak(instr);
                        lastSpokenStep = nextManeuver;
                        nextManeuver.done = true;
                    }
                } else {
                    document.getElementById('nav-next').innerText = 'ã¾ã‚‚ãªãåˆ°ç€';
                }

                const remaining = calculateRemainingDistance(navIndex, routeCoords);
                document.getElementById('nav-remaining').innerText = `æ®‹ã‚Š: ${remaining}`;

                if (!isReal && navIndex >= routeCoords.length) {
                    stopNav();
                    speak("ç›®çš„åœ°ã«åˆ°ç€ã—ã¾ã—ãŸ");
                    alert("ç›®çš„åœ°ã«åˆ°ç€ã—ã¾ã—ãŸ");
                }
            }, 500);
        }

        function stopNav() {
            if (navInterval) clearInterval(navInterval);
            navInterval = null;

            // --- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¤‰æ›´: ã‚µã‚¤ãƒ‰ãƒãƒ¼å†è¡¨ç¤º ---
            document.getElementById('sidebar').style.display = 'block';
            document.getElementById('topbar').style.display = 'none';
            
            // åœ°å›³ã‚µã‚¤ã‚ºæ›´æ–°ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¤‰æ›´ã‚’åæ˜ ï¼‰
            setTimeout(() => map.invalidateSize(), 100);

            if (routeLine) map.removeLayer(routeLine);
            routeLine = null;
            routeCoords = [];
            maneuvers = [];
            navIndex = 0;
            document.getElementById('streetview').style.display = 'none';
            document.getElementById('streetview').innerHTML = '';
            useGPS = true;
            lastSpokenStep = null;
        }

        function getDistance(a, b) {
            const R = 6371000;
            const dLat = (b[0] - a[0]) * Math.PI / 180;
            const dLon = (b[1] - a[1]) * Math.PI / 180;
            const lat1 = a[0] * Math.PI / 180, lat2 = b[0] * Math.PI / 180;
            const d = Math.sin(dLat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
            return 2 * R * Math.atan2(Math.sqrt(d), Math.sqrt(1 - d));
        }

        function calculateRemainingDistance(idx, coords) {
            if (idx === null) return '-';
            let sum = 0;
            for (let i = idx; i < coords.length - 1; i++) sum += getDistance(coords[i], coords[i + 1]);
            return sum >= 1000 ? (sum / 1000).toFixed(1) + ' km' : Math.round(sum / 10) * 10 + ' m';
        }

        function getInstructionText(m) {
            const type = m.type;
            const mod = m.modifier;
            const name = m.name || '';
            const destinations = (m.destinations || '').split(',')[0];
            const exits = m.exits;
            const classes = m.classes || [];

            if (classes.includes('toll_booth')) return (name || 'æ–™é‡‘æ‰€') + ' ã‚’é€šéã—ã¾ã™';
            if (type === 'service' || classes.includes('service_area') || classes.includes('rest_area')) return (name || 'ã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒªã‚¢') + ' ã«å…¥ã‚Šã¾ã™';
            if (type === 'off ramp' && (name.toUpperCase().includes('PA') || name.toUpperCase().includes('SA'))) return name + ' ã«å…¥ã‚Šã¾ã™';

            switch (type) {
                case 'depart': return (name || 'é“è·¯') + ' ã«å…¥ã‚Šã¾ã™';
                case 'on ramp': return (name || 'ãƒ©ãƒ³ãƒ—') + ' ã‹ã‚‰é«˜é€Ÿé“è·¯ã«å…¥ã‚Šã¾ã™';
                case 'off ramp': return (destinations ? destinations + ' æ–¹é¢ã€' : '') + (name || 'å‡ºå£') + (exits ? ' (å‡ºå£ ' + exits + ')' : '') + ' ã§é«˜é€Ÿé“è·¯ã‚’é™ã‚Šã¾ã™';
                case 'fork': return (name ? name + ' ã§ ' : '') + (destinations ? destinations + ' æ–¹é¢ã€' : '') + getDirectionText(mod) + ' æ–¹å‘ã§ã™';
                case 'merge': return (destinations ? destinations + ' æ–¹é¢ã€' : '') + (name ? name + ' ã‹ã‚‰ ' : '') + 'åˆæµã—ã¾ã™';
                case 'turn':
                    if (mod === 'uturn') return 'Uã‚¿ãƒ¼ãƒ³ã—ã¾ã™';
                    if (name) return name + ' ã‚’ ' + getDirectionText(mod) + ' æ–¹å‘ã§ã™';
                    return getDirectionText(mod) + ' ã«æ›²ãŒã‚Šã¾ã™';
                case 'continue':
                case 'new name':
                    if (mod === 'uturn') return 'Uã‚¿ãƒ¼ãƒ³ã—ã¾ã™';
                    if (name) return name + ' ã«å…¥ã‚Šã¾ã™';
                    return 'é“ãªã‚Šã«é€²ã‚€';
                case 'roundabout': return 'ãƒ­ãƒ¼ã‚¿ãƒªãƒ¼ã«å…¥ã‚Šã¾ã™';
                case 'arrive': return 'ç›®çš„åœ°ã«åˆ°ç€ã—ã¾ã™';
                default: return mod ? getDirectionText(mod) + ' ã«æ›²ãŒã‚Šã¾ã™' : 'é“ãªã‚Šã«é€²ã‚€';
            }
        }

        function getDirectionText(mod) {
            switch (mod) {
                case 'left': return 'å·¦';
                case 'right': return 'å³';
                case 'slight left': return 'ã‚„ã‚„å·¦';
                case 'slight right': return 'ã‚„ã‚„å³';
                case 'sharp left': return 'ãã¤ãå·¦';
                case 'sharp right': return 'ãã¤ãå³';
                case 'straight': return 'ç›´é€²';
                default: return 'é€²ã‚€';
            }
        }

        function speak(text) {
            if (!speech) return;
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'ja-JP';
            speech.speak(u);
        }
    </script>
</body>
</html>
